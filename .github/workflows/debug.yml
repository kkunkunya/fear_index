name: Telegram Connection Test

# æ‰‹åŠ¨è§¦å‘çš„è°ƒè¯•å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'telegram'
        type: choice
        options:
        - telegram
        - full_debug
        - test_monitor

permissions:
  contents: write  # å…è®¸æäº¤state.json
  actions: read

jobs:
  telegram-test:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'telegram' || github.event.inputs.test_type == 'full_debug'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Test Telegram Connection
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ”§ å¼€å§‹Telegramè¿æ¥æµ‹è¯•..."
          python test_telegram.py

      - name: Debug Environment Variables
        if: github.event.inputs.test_type == 'full_debug'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ” ç¯å¢ƒå˜é‡è°ƒè¯•ä¿¡æ¯:"
          echo "BOT_TOKEN length: ${#TELEGRAM_BOT_TOKEN}"
          echo "CHAT_ID length: ${#TELEGRAM_CHAT_ID}"
          echo "BOT_TOKEN starts with: ${TELEGRAM_BOT_TOKEN:0:10}..."
          echo "CHAT_ID: $TELEGRAM_CHAT_ID"

  test-monitor:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'test_monitor'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test Monitor Mode (Force Run)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FGI_RUN_MODE: test
        run: |
          echo "ğŸ§ª æµ‹è¯•ç›‘æ§æ¨¡å¼ï¼ˆå¼ºåˆ¶è¿è¡Œï¼‰..."
          echo "è¿™å°†å¿½ç•¥æ—¥æœŸæ£€æŸ¥ï¼Œå¼ºåˆ¶æ‰§è¡ŒFGIç›‘æ§é€»è¾‘"
          python -m src.fgi_notifier test

      - name: Commit state changes
        run: |
          if [[ -n "$(git status --porcelain state/state.json 2>/dev/null)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add state/state.json
            git commit -m "chore(state): update test state on $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          else
            echo "No state changes to commit."
          fi

  full-system-debug:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full_debug'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug FGI System
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FGI_RUN_MODE: monitor
        run: |
          echo "ğŸ” å®Œæ•´ç³»ç»Ÿè°ƒè¯•..."
          echo "1. æµ‹è¯•FGIæ•°æ®è·å–..."
          python -c "
          from src.fgi_notifier import fetch_fgi
          try:
              data = fetch_fgi()
              print(f'âœ… FGIæ•°æ®è·å–æˆåŠŸï¼Œå…±{len(data)}æ¡è®°å½•')
              if data:
                  latest = data[-1]
                  print(f'æœ€æ–°æ•°æ®: {latest[0]} = {latest[1]}')
          except Exception as e:
              print(f'âŒ FGIæ•°æ®è·å–å¤±è´¥: {e}')
          "

          echo "2. æµ‹è¯•çŠ¶æ€ç®¡ç†..."
          python -c "
          from src.state import load_state, save_state
          try:
              state = load_state()
              print(f'âœ… çŠ¶æ€æ–‡ä»¶è¯»å–æˆåŠŸ')
              print(f'çŠ¶æ€å†…å®¹: {state}')
          except Exception as e:
              print(f'âŒ çŠ¶æ€æ–‡ä»¶è¯»å–å¤±è´¥: {e}')
          "

          echo "3. è¿è¡Œå®Œæ•´ç›‘æ§é€»è¾‘..."
          python -m src.fgi_notifier monitor